<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <!-- Esta librería nos permite enviar consultas directamente a la base de datos
         desde el navegador, asi como invocar las funciones definidas en el servidor-->
    <script src="https://unpkg.com/realm-web@0.8.0/dist/bundle.iife.js"></script>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
    crossorigin="anonymous"></script>        

    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"></script>    
    <link rel="stylesheet" 
        href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" 
        crossorigin="anonymous">

</head>

<script type="application/javascript">

//guardamos el esquema en esta variable
let esquema = null
//Guardamos la persona seleccionada
let personaSel = null
//Usuario autenticado
let usuario = null

function conectar(callback){

    //Creamos el objeto aplicación.
    //Esta tarea es síncrona
    const app = new Realm.App({ id: "borrar-opkdk" });

    const mongo = app.services.mongodb("mongodb-atlas");
    esquema = mongo.db("borrar")
    callback()

    console.log("==========================")
    for(a in app){
        console.log(a)
    }
    console.log("==========================")
    for(a in app.functions){
        console.log(a)
    }
    console.log(app.users)

    app.users[0].functions.sumar(10,20)
    .then( rs => console.log(rs))
    .catch(error => console.log(error))
    
    app.users[0].functions.esfurrular()
    .then( rs => console.log(rs))
    .catch(error => console.log(error))
    

    let usuario = app.currentUser
    console.log(usuario)
    console.log(usuario.customData)

    
    
    esquema
        .collection("usuarios_info")
        .updateOne(
            { idUsuario : usuario._id },
            { $set : { dato : "OJO AL DATO "} }
        )
        .then( rs => {
            console.log(rs)
            //Comprobamos que se ha modificado un documento
            if( rs.modifiedCount!=1){
                console.log("Error al modificar los datos del usuario")
                return
            }            
        })

    app.currentUser.refreshCustomData()
    .then( x => console.log(x))
    .catch( e => console.log(e))

/*
    esquema
    .collection('usuarios_info')
    .insertOne({ idUsuario : usuario._id, dato : "???"})
    .then( X => {
        console.log("Insertado:",X)
        listarPersonas()
    })
    .catch( error => console.log(error))*/



    /*
    const email = "ringo@correo.es"
    const password = "1234567890"
    app.emailPasswordAuth.registerUser(email, password)
    .then( rs => console.log(rs))
    .catch(error => console.log(error))
    */

}

exports = async function(arg){
  /*
    Accessing application's values:
    var x = context.values.get("value_name");

    Accessing a mongodb service:
    var collection = context.services.get("mongodb-atlas").db("dbname").collection("coll_name");
    var doc = collection.findOne({owner_id: context.user.id});

    To call other named functions:
    var result = context.functions.execute("function_name", arg1, arg2);

    Try running in the console below.
  */
  
  var collection = context.services.get("mongodb-atlas").db("borrar").collection("personas");
  let personas = await collection.find().toArray();
  
  console.log("HOLA")
  
  //console.log(JSON.stringify(personas))
  
  /*
  let nombres = ""
  for(let p of personas){
    nombres += ","+p.nombre
  }
  */
  
  let nombres = personas.map( p => p.nombre).reduce( (acumulador, p)=> acumulador+","+p )
  
  return nombres;
};



function insertarPersona(){
    //crear un objeto con los datos del formulario
    let persona = {}
    $("#formulario [campo]").each(function(pos, nodo){
        persona[nodo.id] = nodo.value
    })
    persona.idUsuario = usuario
    console.log(persona)

    //
    //QUERY ANYWHERE
    //
    //Haz las consultas donde te salga de las narices

    //enviar el insert al servidor
    esquema
        .collection('personas')
        .insertOne(persona)
        .then( X => {
            console.log("Insertado:",X)
            listarPersonas()
        })
        .catch( error => console.log(error))
}

function seleccionarPersona(id){
    esquema
        .collection("personas")
        .findOne({ _id : id})
        .then( persona => {
            if(!persona){
                console.log("No existe una persona con ese id")
                return
            }
            rellenarFormulario(persona)
        })
        .catch( error => console.log(error))
}

function rellenarFormulario(persona){
    for(let propiedad in persona){
        $("#formulario [id="+propiedad+"]").val(persona[propiedad])
    }
    personaSel = persona
}

function listarPersonas(){
    esquema
        .collection('personas')
        .find()
        //.toArray()
        .then( personas => rellenartabla(personas) )
        .catch( error => console.log(error))
}

function rellenartabla(personas){
    $("#tablaPersonas").html('')
    $(personas).each(function(pos, persona){
        $(`<tr>
                <td>${persona.nombre}</td>
                <td>${persona.direccion}</td>
                <td>${persona.telefono}</td>
                <td>${persona.correoE}</td>
           </tr>`)
        .click(function(){
            seleccionarPersona(persona._id)            
        })
        .appendTo("#tablaPersonas")
    })    
}

function modificarPersona(){
    let persona = {}
    $("#formulario [campo]").each( (pos,nodo) => {
        persona[nodo.id] = nodo.value
    })

    esquema
        .collection("personas")
        .updateOne( { _id : personaSel._id },
                    { $set : persona } )
        .then( rs => {
            vaciarFormulario()
            listarPersonas()
        })
        .catch( error => console.log(error) )        
}

function borrarPersona(){
    esquema
        .collection("personas")
        .deleteOne( { _id : personaSel._id } )
        .then( rs => {
            vaciarFormulario()
            listarPersonas()
        })
        .catch( error => console.log(error) )
}

function vaciarFormulario(){
    $("#formulario [campo]").val('')
    personaSel = null
}

function logout(){
    const app = new Realm.App({ id: "borrar-opkdk" })
    console.log(app.allUsers)
    app.allUsers.forEach( user => user.logOut())
}

$(inicializar)
function inicializar(){
    $("#btnInsertar").click(insertarPersona)
    $("#btnModificar").click(modificarPersona)
    $("#btnBorrar").click(borrarPersona)
    $("#btnVaciar").click(vaciarFormulario)
    $("#btnLogout").click(logout)
    conectar(listarPersonas)
}

</script>

<body>
  
    <div class="jumbotron">
        <h1>Agenda 3000 Stitch Edition (Usuarios)</h1>
    </div>
    
    <div class="text-center mt-2 mb-2">
        <button class="btn btn-primary mr-1" id="btnInsertar">Insertar</button>
        <button class="btn btn-primary mr-1" id="btnModificar">Modificar</button>
        <button class="btn btn-danger  mr-1" id="btnBorrar">Borrar</button>
        <button class="btn btn-warning mr-1" id="btnVaciar">Vaciar</button>
        <button class="btn btn-warning mr-1" id="btnLogout">Logout</button>
    </div>

    <div class="row">
        <div class="col-sm-12 col-lg-8 offset-lg-2"> 
            <!--$("#formulario [campo]")-->
            <div class="row" id="formulario">  

                <div class="col-2 mt-1">
                    <label>Nombre</label>
                </div>
                <div class="col-10 mt-1">
                    <input class="form-control" campo="" id="nombre"/>
                </div>

                <div class="col-2 mt-1">
                    <label>Direccion</label>
                </div>
                <div class="col-10 mt-1">
                    <input class="form-control" campo="" id="direccion"/>
                </div>

                <div class="col-2 mt-1">
                    <label>Telefono</label>
                </div>
                <div class="col-10 mt-1">
                    <input class="form-control" campo="" id="telefono"/>
                </div>
             
                <div class="col-2 mt-1">
                    <label>Correo E</label>
                </div>
                <div class="col-10 mt-1">
                    <input class="form-control" campo="" id="correoE"/>
                </div>                 
            </div>         
        </div>
    </div>

    <div class="row">
        <div class="col-sm-12 col-lg-8 offset-lg-2"> 
            <table class="table table-striped table-hover mt-4">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Dirección</th>
                        <th>Teléfono</th>
                        <th>Correo E</th>
                    </tr>
                </thead>
                <tbody id="tablaPersonas">
                </tbody>
            </table>
        </div>
    </div>    

</body>
</html>




